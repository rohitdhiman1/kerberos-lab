version: '3.8'

services:
  kdc:
    image: ubuntu:22.04
    container_name: kerberos-kdc-lab02
    hostname: kdc.example.com
    networks:
      kerberos-net:
        ipv4_address: 172.20.0.10
    environment:
      - REALM=${REALM}
      - KDC_PASSWORD=${KDC_PASSWORD}
    volumes:
      - ../../common/config-templates:/config-templates:ro
      - ../../common/scripts:/scripts:ro
      - kdc-data:/var/kerberos-data
    command: /scripts/kdc-init.sh
    healthcheck:
      test: ["CMD", "kadmin.local", "-q", "listprincs"]
      interval: 10s
      timeout: 5s
      retries: 5

  webserver:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: kerberos-web
    hostname: web.example.com
    networks:
      kerberos-net:
        ipv4_address: 172.20.0.20
    ports:
      - "${WEB_PORT}:80"
    environment:
      - REALM=${REALM}
      - KDC_HOST=kdc.example.com
      - SERVICE_PRINCIPAL=HTTP/web.example.com@${REALM}
    volumes:
      - ./keytabs:/etc/keytabs
      - ./web-content:/var/www/html
      - ./apache-config/auth.conf:/etc/apache2/conf-available/auth.conf:ro
    depends_on:
      kdc:
        condition: service_healthy
    command: /bin/bash -c "sleep 5 && apache2ctl -D FOREGROUND"

  client:
    image: ubuntu:22.04
    container_name: kerberos-client-lab02
    hostname: client.example.com
    networks:
      kerberos-net:
        ipv4_address: 172.20.0.30
    environment:
      - REALM=${REALM}
      - KDC_HOST=kdc.example.com
      - KDC_PASSWORD=${KDC_PASSWORD}
    volumes:
      - ../../common/config-templates:/config-templates:ro
      - ./test-scripts:/test-scripts:ro
    depends_on:
      kdc:
        condition: service_healthy
      webserver:
        condition: service_started
    stdin_open: true
    tty: true
    command: /bin/bash

networks:
  kerberos-net:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/24

volumes:
  kdc-data:
