version: '3.8'

services:
  kdc:
    image: ubuntu:22.04
    container_name: kerberos-kdc-lab05
    hostname: kdc.example.com
    networks:
      db-kerberos-net:
        ipv4_address: 172.26.0.10
    environment:
      - REALM=${REALM}
      - KDC_PASSWORD=${KDC_PASSWORD}
    volumes:
      - ../../common/config-templates:/config-templates:ro
      - ../../common/scripts:/scripts:ro
      - kdc-data:/var/kerberos-data
    command: /scripts/kdc-init.sh
    healthcheck:
      test: ["CMD", "kadmin.local", "-q", "listprincs"]
      interval: 10s
      timeout: 5s
      retries: 5

  postgres:
    build:
      context: .
      dockerfile: Dockerfile.postgres
    container_name: postgres-kerberos
    hostname: postgres.example.com
    networks:
      db-kerberos-net:
        ipv4_address: 172.26.0.20
    ports:
      - "${POSTGRES_PORT}:5432"
    environment:
      - POSTGRES_PASSWORD=${POSTGRES_ADMIN_PASSWORD}
      - REALM=${REALM}
      - KDC_HOST=kdc.example.com
      - SERVICE_PRINCIPAL=postgres/postgres.example.com@${REALM}
    volumes:
      - ./keytabs:/etc/keytabs
      - ./postgres-config/postgresql.conf:/etc/postgresql/postgresql.conf:ro
      - ./postgres-config/pg_hba.conf:/etc/postgresql/pg_hba.conf:ro
      - ./sql-init:/docker-entrypoint-initdb.d:ro
      - ./krb5.conf:/etc/krb5.conf:ro
      - postgres-data:/var/lib/postgresql/data
    depends_on:
      kdc:
        condition: service_healthy

  client:
    image: ubuntu:22.04
    container_name: db-client
    hostname: client.example.com
    networks:
      db-kerberos-net:
        ipv4_address: 172.26.0.30
    environment:
      - REALM=${REALM}
      - KDC_HOST=kdc.example.com
      - POSTGRES_HOST=postgres.example.com
      - DB_USER=${DB_USER}
      - DB_PASSWORD=${DB_PASSWORD}
    volumes:
      - ./krb5.conf:/etc/krb5.conf:ro
      - ./test-scripts:/test-scripts:ro
      - ./client-examples:/client-examples:ro
    depends_on:
      kdc:
        condition: service_healthy
      postgres:
        condition: service_started
    stdin_open: true
    tty: true
    command: /bin/bash

networks:
  db-kerberos-net:
    driver: bridge
    ipam:
      config:
        - subnet: 172.26.0.0/24

volumes:
  kdc-data:
  postgres-data:
