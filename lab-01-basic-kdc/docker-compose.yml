version: '3.8'

services:
  kdc:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: kerberos-kdc
    # Load environment variables from the .env file
    env_file:
      - .env
    hostname: ${KRB_KDC_HOSTNAME} # Set hostname for Kerberos to resolve correctly
    ports:
      - "88:88"     # Kerberos KDC Port (UDP/TCP)
      - "749:749"   # Kerberos Admin Server Port (TCP)
      - "464:464"   # Kerberos Password Change Port (UDP/TCP)
    volumes:
      # Persistent KDC Database
      - ${KRB_KDC_DB_VOLUME_PATH}:/var/lib/krb5kdc
      # Share krb5.conf with the host for easy client configuration
      - ${KRB_CONFIG_VOLUME_PATH}/krb5.conf:/etc/krb5.conf:ro
    networks:
      - krb_net
    healthcheck:
      test: ["CMD", "klist", "-k", "/etc/krb5kdc/kadm5.keytab"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    restart: unless-stopped

  client:
    image: ubuntu:22.04
    container_name: kerberos-client
    env_file:
      - .env
    networks:
      - krb_net
    command: tail -f /dev/null # Keep client container running for interactive testing
    volumes:
      # Mount the generated krb5.conf for client configuration
      - ${KRB_CONFIG_VOLUME_PATH}/krb5.conf:/etc/krb5.conf:ro
      # Mount a keytabs directory to store client keytabs on the host
      - ${KRB_KEYTAB_VOLUME_PATH}:/keytabs
    depends_on:
      kdc:
        condition: service_healthy

networks:
  krb_net:
    driver: bridge